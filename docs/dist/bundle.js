(()=>{"use strict";let t=null;const e="http://localhost:3001/api/todos",n=/github\.io$/.test(location.host)||/\.github\.io\//.test(location.href),o="todos",i=document.getElementById("todo-list"),c=document.getElementById("todo-form"),a=document.getElementById("todo-input"),d=document.getElementById("desc-input"),s=document.getElementById("popup"),l=document.getElementById("popup-title"),r=document.getElementById("popup-desc"),u=document.getElementById("popup-view"),p=document.getElementById("edit-btn"),y=document.getElementById("popup-edit"),m=document.getElementById("edit-title"),f=document.getElementById("edit-desc"),h=document.getElementById("cancel-edit");function g(){try{const t=localStorage.getItem(o);return t?JSON.parse(t):[]}catch{return[]}}function w(t){localStorage.setItem(o,JSON.stringify(t))}function E(t){return t.length?Math.max(...t.map(t=>t.id))+1:1}async function I(){var o;o=n?await async function(){const t=g();if(t.length)return t;const e=await fetch("./data/todos.json");if(!e.ok)return[];const n=await e.json();return w(n),n}():await async function(){const t=await fetch(e);if(!t.ok)throw new Error("Fetch todos failed");return await t.json()}(),i.innerHTML="",o.forEach(o=>{const c=document.createElement("li"),a=document.createElement("input");a.type="checkbox",a.checked=o.completed,a.onclick=async t=>{t.stopPropagation(),await b(o.id,{completed:!o.completed}),I()},c.appendChild(a);const d=document.createElement("span");d.textContent=o.title,d.style.textDecoration=o.completed?"line-through":"",d.style.cursor="pointer",d.onclick=async()=>{try{const i=await async function(t){return n?await async function(t){const e=g().find(e=>e.id===t);if(!e)throw new Error("Todo not found");return e}(t):await async function(t){const n=await fetch(`${e}/${t}`);if(!n.ok)throw new Error("Todo not found");return await n.json()}(t)}(o.id);t=i,l.textContent=i.title,r.textContent=i.description||"(Không có mô tả)",u.style.display="",y.style.display="none",s.setAttribute("data-id",String(i.id)),s.style.display="block"}catch{alert("Không tìm thấy công việc này!")}},c.appendChild(d);const p=document.createElement("button");p.textContent="X",p.onclick=async t=>{t.stopPropagation(),await async function(t){return n?async function(t){w(g().filter(e=>e.id!==t))}(t):async function(t){await fetch(`${e}/${t}`,{method:"DELETE"})}(t)}(o.id),I()},c.appendChild(p),i.appendChild(c)})}async function b(t,o){return n?async function(t,e){const n=g(),o=n.findIndex(e=>e.id===t);-1!==o&&(n[o]={...n[o],...e},w(n))}(t,o):async function(t,n){await fetch(`${e}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}(t,o)}p.onclick=()=>(t&&(m.value=t.title,f.value=t.description),u.style.display="none",y.style.display="flex",!1),h.onclick=()=>(u.style.display="",y.style.display="none",!1),y.onsubmit=async t=>{t.preventDefault();const e=s.getAttribute("data-id");if(!e)return;const n=Number(e);await b(n,{title:m.value,description:f.value}),s.style.display="none",I()},c.onsubmit=async t=>{t.preventDefault();const o=a.value.trim(),i=d.value.trim();o&&(await async function(t,o){return n?async function(t){const e=g(),n={id:E(e),title:t.title,description:t.description??"",completed:!1};e.push(n),w(e)}({title:t,description:o}):async function(t){await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,description:t.description})})}({title:t,description:o})}(o,i),a.value="",d.value="",I())},I()})();